<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="nickname-container">
        <input type="text" class="nickname-input" placeholder="Enter your nickname">
        <button class="nickname-button">Join Chat</button>
    </div>
    <div class="chat disable">
        <div class="chat-container"></div>
        <div class="input-container">
            <input type="text" class="input-field" placeholder="Type a message...">
            <button class="send-button">Send</button>
        </div>
    </div>
    <script>
        const nicknameContainer = document.querySelector('.nickname-container');
        const nicknameInput = document.querySelector('.nickname-input');
        const nicknameButton = document.querySelector('.nickname-button');
        const chat = document.querySelector('.chat');
        const chatContainer = document.querySelector('.chat-container');
        const inputField = document.querySelector('.input-field');
        const sendButton = document.querySelector('.send-button');
        let username = '';
        let ws = null;
        let displayedMessageIds = new Set();

        function processMessage(data) {
            if (data.id && displayedMessageIds.has(data.id)) {
                return;
            }
            if (data.id) {
                displayedMessageIds.add(data.id);
            }

            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            if (data.user === username) {
                const responseElement = document.createElement('div');
                responseElement.classList.add('response');

                const authorElement = document.createElement('p');
                authorElement.classList.add('author');
                authorElement.textContent = data.user;

                const textElement = document.createElement('p');
                textElement.classList.add('text');
                textElement.textContent = data.message;

                responseElement.appendChild(authorElement);
                responseElement.appendChild(textElement);
                messageElement.appendChild(responseElement);
            } else {
                const authorElement = document.createElement('p');
                authorElement.classList.add('author');
                authorElement.textContent = data.user;

                const textElement = document.createElement('p');
                textElement.classList.add('text');
                textElement.textContent = data.message;

                messageElement.appendChild(authorElement);
                messageElement.appendChild(textElement);
            }

            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        nicknameButton.addEventListener('click', () => {
            if (nicknameInput.value.trim() !== '') {
                username = nicknameInput.value.trim();
                nicknameContainer.classList.add('disable');
                chat.classList.remove('disable');
                connectWebSocket();
            }
        });

        async function send() {
            const message = inputField.value.trim();
            if (message && username) {
                const tempId = 'temp-' + Date.now();
                const messageData = { id: tempId, user: username, message: message };
                processMessage(messageData);
                try {
                    const res = await fetch("http://127.0.0.1:8000/send", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ user: username, message })
                    });
                    await res.json();
                } catch (error) {
                    console.error("Ошибка отправки сообщения:", error);
                }
                inputField.value = '';
            }
        }

        sendButton.addEventListener('click', send);
        inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') send();
        });

        function connectWebSocket() {
            ws = new WebSocket("ws://127.0.0.1:8000/ws");
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                processMessage(data);
            };
            ws.onclose = () => {
                console.log("WebSocket закрыт, пытаюсь переподключиться...");
                setTimeout(connectWebSocket, 1000);
            };
        }

        window.addEventListener('load', async () => {
            try {
                const res = await fetch("http://127.0.0.1:8000/messages");
                const { messages } = await res.json();
                messages.forEach(processMessage);
            } catch (err) {
                console.error("Ошибка загрузки истории сообщений:", err);
            }
        });
    </script>
</body>
</html>
